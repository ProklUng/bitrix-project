##########
# Роутер
##########

parameters:
  router.request_context.host: localhost
  router.request_context.scheme: http
  router.request_context.base_url: ~

services:
  # конфигурация по умолчанию в *этом* файле
  _defaults:
    autowire: true
    autoconfigure: true
    public: true

  # Инициализация роутера Symfony.
  # custom.events.init: если ['custom.events.init'], то инициализация пойдет через трэйт Eventable.
  # Если -  { name: 'custom.events.init', event: 'template_redirect', method: 'router', priority: 5 }
  # то вызовется метод с приоритетом.
  symfony_router:
    class: Fedy\Services\SymfonyRouter
    arguments:
      - '@symfony.routes.collection'
      - '@json.error.controller'
      - '@event_dispatcher'
      - '@Symfony\Component\HttpKernel\Controller\ControllerResolver'
      - '@argument_resolver'
      - '@global.request'
    tags:
      - { name: 'custom.events.init', event: 'template_redirect', type: 'add_action', method: 'router', priority: 5 }

  # Конечный сервис чтения и загрузки анотированных роутов.
  load.annotated.routes:
    class: Fedy\Services\Router\Annotations\LoadAnnotatedRoutes
    arguments: ['@class.collector', '@symfony.loader.annotated.routes']

  # Symfony загрузчик аннотированных роутов.
  symfony.loader.annotated.routes:
    class: Symfony\Bundle\FrameworkBundle\Routing\AnnotatedRouteControllerLoader
    arguments: ['@Local\PhpAnnotations\ForkAnnotationReader']

  #########
  # Роутер
  #########

  # Загрузчик нативных роутов Symfony.
  loader.yaml.config.routes:
    class: Fedy\App\RoutesYamlConfigLoader
    arguments: ['%kernel.project_dir%', '%base.config.path%', '@load.annotated.routes','%yaml.main.routes.file%']

  Fedy\App\RoutesYamlConfigLoader: '@loader.yaml.config.routes'

  # RoutesCollection нативных роутов Symfony.
  symfony.routes.collection:
    class: Symfony\Component\Routing\RouteCollection
    factory: ['@loader.yaml.config.routes', 'load']

  symfony.get.routes:
    class: Symfony\Component\Routing\RouteCollection
    factory: ['@loader.yaml.config.routes', 'routes']

  ##########################################
  # Subscribers Symfony HttpKernel events.
  ##########################################

  # kernel.controller
  Fedy\Events\OnControllerRequest\Subscribers\AjaxCall:
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 5 }

  Fedy\Events\OnControllerRequest\Subscribers\InjectServiceController:
    class: Fedy\Events\OnControllerRequest\Subscribers\InjectServiceController
    arguments: ['@service_container']
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 60 }

  Fedy\Events\OnControllerRequest\Subscribers\SecurityToken:
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 15 }

  Fedy\Events\OnControllerRequest\Subscribers\SetContainer:
    class: Fedy\Events\OnControllerRequest\Subscribers\SetContainer
    arguments: ['@service_container']
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 55 }

  Fedy\Events\InjectorController\Fabrics:
    class: Fedy\Events\InjectorController\Fabrics
    arguments: ['@service_container']

  Fedy\Events\OnControllerRequest\Subscribers\ResolverParamsController:
    class: Fedy\Events\OnControllerRequest\Subscribers\ResolverParamsController
    arguments: ['@Fedy\Events\InjectorController\Fabrics']
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 55 }

  Fedy\Events\OnControllerRequest\Subscribers\BootTraits:
    tags:
      - { name: kernel.event_listener, event: kernel.controller, method: handle, priority: 50 }

  # kernel.request
  Fedy\Events\OnKernelRequest\Subscribers\SetSession:
    class: Fedy\Events\OnKernelRequest\Subscribers\SetSession
    arguments: ['@service_container']
    tags:
      - { name: kernel.event_listener, event: kernel.request, method: handle, priority: 10 }

  Fedy\Events\OnKernelRequest\Subscribers\ValidatorRequestCsrfToken:
    class: Fedy\Events\OnKernelRequest\Subscribers\ValidatorRequestCsrfToken
    arguments: ['@service_container']
    tags:
      - { name: kernel.event_listener, event: kernel.request, method: handle, priority: 10 }

  Fedy\Events\OnKernelRequest\Subscribers\FormUrlencodedTreatment:
    tags:
      - { name: kernel.event_listener, event: kernel.request, method: handle, priority: 10 }

  #  Fedy\Events\OnKernelResponse\Subscribers\SetHeaders:
  #    arguments: ['@Symfony\Component\ExpressionLanguage\ExpressionLanguage', '@headers.response.config']
  #    tags:
  #      - { name: kernel.event_listener, event: kernel.response, method: handle, priority: 10 }

  Symfony\Component\HttpKernel\Controller\ControllerResolver: ~

  # Стандартный контроллер ошибок.
  standart.error.controller:
    class: Fedy\wpSymfonyRouter\ErrorController

  Fedy\wpSymfonyRouter\ErrorController: '@standart.error.controller'

  # Json контроллер ошибок.
  json.error.controller:
    class: Fedy\wpSymfonyRouter\ErrorJsonController
    arguments: ['@serializer']

  Fedy\wpSymfonyRouter\ErrorJsonController: '@json.error.controller'

  # Поисковик классов в директориях.
  class.collector:
    class: Fedy\Services\Router\Annotations\SearchAnnotatedClasses
    arguments: ['%kernel.project_dir%', '%controller.annotations.path%']

  # Диспетчер запуска контроллеров.
  dispatcher.controller:
    class: Local\SymfonyTools\Framework\DispatchController
    arguments:
      - '@event_dispatcher'
      - '@Symfony\Component\HttpKernel\Controller\ControllerResolver'
      - '@json.error.controller'

  Local\SymfonyTools\Framework\DispatchController: '@dispatcher.controller'

  # Диспетчер запуска роутов.
  dispatcher.route:
    class: Local\SymfonyTools\Framework\Utils\DispatchRoute
    arguments: ['@event_dispatcher','@json.error.controller', '@Symfony\Component\HttpKernel\Controller\ControllerResolver', '@serializer']

  Local\SymfonyTools\Framework\Utils\DispatchRoute: '@dispatcher.route'
